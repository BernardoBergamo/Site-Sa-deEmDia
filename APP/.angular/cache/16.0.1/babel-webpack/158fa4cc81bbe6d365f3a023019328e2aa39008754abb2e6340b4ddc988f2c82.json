{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/andre/source/repos/Unisinos.SaudeEmDia/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport * as i0 from \"@angular/core\";\nconst _c0 = [\"local\"];\nconst _c1 = [\"remote\"];\n// import { AngularFireDatabase, AngularFireList } from 'angularfire2/database';\n// import * as firebase from \"firebase/app\";\nclass WebRtcComponent {\n  constructor() {\n    this.title = 'Unisinos.SaudeEmDia';\n    this.callActive = false;\n    this.rtcConfig = {\n      bundlePolicy: undefined,\n      certificates: [],\n      iceCandidatePoolSize: 10,\n      iceServers: [{\n        urls: \"stun:stun.services.mozilla.com\"\n      }, {\n        urls: \"stun:stun.l.google.com:19302\"\n      }],\n      iceTransportPolicy: undefined,\n      rtcpMuxPolicy: undefined\n    };\n    this.pc = new RTCPeerConnection(this.rtcConfig);\n    // channel: AngularFireList<{}>;\n    // database: firebase.database.Reference;\n    this.senderId = \"\";\n  }\n  ngOnInit() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      yield _this.setupWebRtc();\n    })();\n  }\n  ngOnDestroy() {\n    this.pc.close();\n    let tracks = this.localStream.getTracks();\n    for (let i = 0; i < tracks.length; i++) {\n      tracks[i].stop();\n    }\n    this.callActive = false;\n  }\n  setupWebRtc() {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      _this2.senderId = _this2.guid();\n      var channelName = \"/webrtc\";\n      // this.channel = this.afDb.list(channelName);\n      // this.database = this.afDb.database.ref(channelName);\n      // this.database.on(\"child_added\", this.readMessage.bind(this));\n      // this.pc.onicecandidate = event => {\n      //   event.candidate ? this.sendMessage(this.senderId, JSON.stringify({ ice: event.candidate })) : console.log(\"Sent All Ice\");\n      // }\n      // this.pc.onremovestream = event => {\n      //   console.log('Stream Ended');\n      // }\n      _this2.pc.ontrack = event => _this2.remote.nativeElement.srcObject = event.streams[0]; // use ontrack\n    })();\n  }\n\n  showLocal() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      navigator.mediaDevices.getUserMedia({\n        audio: true,\n        video: true\n      }).then(stream => _this3.local.nativeElement.srcObject = stream).then(stream => {\n        //this.pc.addStream(stream);\n        _this3.localStream = stream;\n        _this3.callActive = true;\n      });\n    })();\n  }\n  showRemote() {\n    var _this4 = this;\n    return _asyncToGenerator(function* () {\n      yield _this4.showLocal();\n      try {\n        _this4.pc.createOffer().then(offer => _this4.pc.setLocalDescription(offer)).then(() => {\n          //this.sendMessage(this.senderId, JSON.stringify({ sdp: this.pc.localDescription }));\n          _this4.callActive = true;\n        });\n      } catch (error) {\n        console.log(error);\n      }\n    })();\n  }\n  hangup() {\n    this.pc.close();\n    let tracks = this.localStream.getTracks();\n    for (let i = 0; i < tracks.length; i++) {\n      tracks[i].stop();\n    }\n    this.callActive = false;\n  }\n  // sendMessage(senderId: string, data: string) {\n  //   var msg = this.channel.push({ sender: senderId, message: data });\n  //   msg.remove();\n  // }\n  // readMessage(data: any) {\n  //   if (!data) return;\n  //   try {\n  //     var msg = JSON.parse(data.val().message);\n  //     let personalData = data.val().personalData;\n  //     var sender = data.val().sender;\n  //     if (sender != this.senderId) {\n  //       if (msg.ice != undefined && this.pc != null) {\n  //         this.pc.addIceCandidate(new RTCIceCandidate(msg.ice));\n  //       } else if (msg.sdp.type == \"offer\") {\n  //         this.callActive = true;\n  //         this.pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))\n  //           .then(() => this.pc.createAnswer())\n  //           .then((answer: any) => this.pc.setLocalDescription(answer))\n  //           .then(() => this.sendMessage(this.senderId, JSON.stringify({ sdp: this.pc.localDescription })));\n  //       } else if (msg.sdp.type == \"answer\") {\n  //         this.callActive = true;\n  //         this.pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));\n  //       }\n  //     }\n  //   } catch (error) {\n  //     console.log(error);\n  //   }\n  // }\n  guid() {\n    return this.s4() + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + this.s4() + this.s4();\n  }\n  s4() {\n    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);\n  }\n}\nWebRtcComponent.ɵfac = function WebRtcComponent_Factory(t) {\n  return new (t || WebRtcComponent)();\n};\nWebRtcComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: WebRtcComponent,\n  selectors: [[\"app-web-rtc\"]],\n  viewQuery: function WebRtcComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 5);\n      i0.ɵɵviewQuery(_c1, 5);\n    }\n    if (rf & 2) {\n      let _t;\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.local = _t.first);\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.remote = _t.first);\n    }\n  },\n  decls: 13,\n  vars: 2,\n  consts: [[\"mat-raised-button\", \"\", \"color\", \"primary\", 3, \"disabled\", \"click\"], [\"mat-raised-button\", \"\", \"color\", \"warn\", 3, \"disabled\", \"click\"], [1, \"card-container\"], [1, \"card\"], [\"id\", \"local\", \"controls\", \"\", \"autoplay\", \"\", 2, \"height\", \"440px\", \"width\", \"640px\"], [\"local\", \"\"], [\"id\", \"device\", \"controls\", \"\", \"autoplay\", \"\", 2, \"height\", \"440px\", \"width\", \"640px\"], [\"remote\", \"\"]],\n  template: function WebRtcComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\")(1, \"button\", 0);\n      i0.ɵɵlistener(\"click\", function WebRtcComponent_Template_button_click_1_listener() {\n        return ctx.showRemote();\n      });\n      i0.ɵɵtext(2, \"Call\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵtext(3, \"\\u00A0\\u00A0 \");\n      i0.ɵɵelementStart(4, \"button\", 1);\n      i0.ɵɵlistener(\"click\", function WebRtcComponent_Template_button_click_4_listener() {\n        return ctx.hangup();\n      });\n      i0.ɵɵtext(5, \"Hang Up\");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(6, \"div\", 2)(7, \"div\", 3);\n      i0.ɵɵelement(8, \"video\", 4, 5);\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(10, \"div\", 3);\n      i0.ɵɵelement(11, \"video\", 6, 7);\n      i0.ɵɵelementEnd()();\n    }\n    if (rf & 2) {\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"disabled\", ctx.callActive);\n      i0.ɵɵadvance(3);\n      i0.ɵɵproperty(\"disabled\", !ctx.callActive);\n    }\n  },\n  styles: [\"\\n/*# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsInNvdXJjZVJvb3QiOiIifQ== */\"]\n});\nexport { WebRtcComponent };","map":{"version":3,"names":["WebRtcComponent","constructor","title","callActive","rtcConfig","bundlePolicy","undefined","certificates","iceCandidatePoolSize","iceServers","urls","iceTransportPolicy","rtcpMuxPolicy","pc","RTCPeerConnection","senderId","ngOnInit","_this","_asyncToGenerator","setupWebRtc","ngOnDestroy","close","tracks","localStream","getTracks","i","length","stop","_this2","guid","channelName","ontrack","event","remote","nativeElement","srcObject","streams","showLocal","_this3","navigator","mediaDevices","getUserMedia","audio","video","then","stream","local","showRemote","_this4","createOffer","offer","setLocalDescription","error","console","log","hangup","s4","Math","floor","random","toString","substring","selectors","viewQuery","WebRtcComponent_Query","rf","ctx","i0","ɵɵelementStart","ɵɵlistener","WebRtcComponent_Template_button_click_1_listener","ɵɵtext","ɵɵelementEnd","WebRtcComponent_Template_button_click_4_listener","ɵɵelement","ɵɵadvance","ɵɵproperty"],"sources":["C:\\Users\\andre\\source\\repos\\Unisinos.SaudeEmDia\\src\\app\\web-rtc\\web-rtc.component.ts","C:\\Users\\andre\\source\\repos\\Unisinos.SaudeEmDia\\src\\app\\web-rtc\\web-rtc.component.html"],"sourcesContent":["import { Component, OnInit, ViewChild } from '@angular/core';\n// import { AngularFireDatabase, AngularFireList } from 'angularfire2/database';\n// import * as firebase from \"firebase/app\";\n\n@Component({\n  selector: 'app-web-rtc',\n  templateUrl: './web-rtc.component.html',\n  styleUrls: ['./web-rtc.component.scss']\n})\nexport class WebRtcComponent implements OnInit {\n  title = 'Unisinos.SaudeEmDia';\n  callActive: boolean = false;\n  rtcConfig: RTCConfiguration = {\n    bundlePolicy: undefined,\n    certificates: [],\n    iceCandidatePoolSize: 10,\n    iceServers: [\n      { urls: \"stun:stun.services.mozilla.com\" },\n      { urls: \"stun:stun.l.google.com:19302\" }\n    ],\n    iceTransportPolicy: undefined,\n    rtcpMuxPolicy: undefined\n  };\n  pc: RTCPeerConnection = new RTCPeerConnection(this.rtcConfig);\n\n  localStream: any;\n  // channel: AngularFireList<{}>;\n  // database: firebase.database.Reference;\n  senderId: string = \"\";\n\n  @ViewChild(\"local\") local: any;\n  @ViewChild(\"remote\") remote: any;\n\n  constructor(\n    //private afDb: AngularFireDatabase,\n  ) { }\n\n  async ngOnInit() {\n    await this.setupWebRtc();\n  }\n\n  public ngOnDestroy() {\n    this.pc.close();\n    let tracks = this.localStream.getTracks();\n\n    for (let i = 0; i < tracks.length; i++) {\n      tracks[i].stop();\n    }\n\n    this.callActive = false;\n  }\n\n  async setupWebRtc() {\n    this.senderId = this.guid();\n    var channelName = \"/webrtc\";\n    // this.channel = this.afDb.list(channelName);\n    // this.database = this.afDb.database.ref(channelName);\n    // this.database.on(\"child_added\", this.readMessage.bind(this));\n\n    // this.pc.onicecandidate = event => {\n    //   event.candidate ? this.sendMessage(this.senderId, JSON.stringify({ ice: event.candidate })) : console.log(\"Sent All Ice\");\n    // }\n\n    // this.pc.onremovestream = event => {\n    //   console.log('Stream Ended');\n    // }\n\n    this.pc.ontrack = event =>\n      (this.remote.nativeElement.srcObject = event.streams[0]); // use ontrack\n  }\n\n  async showLocal() {\n    navigator.mediaDevices.getUserMedia({ audio: true, video: true })\n      .then(stream => (this.local.nativeElement.srcObject = stream))\n      .then(stream => {\n        //this.pc.addStream(stream);\n\n        this.localStream = stream;\n\n        this.callActive = true;\n      });\n  }\n\n  async showRemote() {\n    await this.showLocal();\n\n    try {\n      this.pc.createOffer()\n        .then((offer: any) => this.pc.setLocalDescription(offer))\n        .then(() => {\n          //this.sendMessage(this.senderId, JSON.stringify({ sdp: this.pc.localDescription }));\n\n          this.callActive = true;\n        });\n    } catch (error) {\n      console.log(error);\n    }\n  }\n\n  hangup() {\n    this.pc.close();\n    let tracks = this.localStream.getTracks();\n\n    for (let i = 0; i < tracks.length; i++) {\n      tracks[i].stop();\n    }\n\n    this.callActive = false;\n  }\n\n  // sendMessage(senderId: string, data: string) {\n  //   var msg = this.channel.push({ sender: senderId, message: data });\n  //   msg.remove();\n  // }\n\n  // readMessage(data: any) {\n  //   if (!data) return;\n  //   try {\n  //     var msg = JSON.parse(data.val().message);\n  //     let personalData = data.val().personalData;\n  //     var sender = data.val().sender;\n\n  //     if (sender != this.senderId) {\n  //       if (msg.ice != undefined && this.pc != null) {\n  //         this.pc.addIceCandidate(new RTCIceCandidate(msg.ice));\n  //       } else if (msg.sdp.type == \"offer\") {\n  //         this.callActive = true;\n  //         this.pc.setRemoteDescription(new RTCSessionDescription(msg.sdp))\n  //           .then(() => this.pc.createAnswer())\n  //           .then((answer: any) => this.pc.setLocalDescription(answer))\n  //           .then(() => this.sendMessage(this.senderId, JSON.stringify({ sdp: this.pc.localDescription })));\n  //       } else if (msg.sdp.type == \"answer\") {\n  //         this.callActive = true;\n  //         this.pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));\n  //       }\n  //     }\n  //   } catch (error) {\n  //     console.log(error);\n  //   }\n  // }\n\n  guid() {\n    return (this.s4() + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + \"-\" + this.s4() + this.s4() + this.s4());\n  }\n  s4() {\n    return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);\n  }\n}\n","<div>\n  <!-- <button mat-raised-button color=\"primary\" (click)=\"showLocal()\" [disabled]=\"callActive\">Local</button>&nbsp;&nbsp; -->\n  <button mat-raised-button color=\"primary\" (click)=\"showRemote()\" [disabled]=\"callActive\">Call</button>&nbsp;&nbsp;\n  <button mat-raised-button color=\"warn\" (click)=\"hangup()\" [disabled]=\"!callActive\">Hang Up</button>\n</div>\n\n<div class=\"card-container\">\n  <div class=\"card\">\n    <video id=\"local\" controls autoplay #local style=\"height: 440px;width: 640px;\"></video>\n  </div>\n\n  <div class=\"card\">\n    <video id=\"device\" controls autoplay #remote style=\"height: 440px;width: 640px;\"> </video>\n  </div>\n</div>\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}